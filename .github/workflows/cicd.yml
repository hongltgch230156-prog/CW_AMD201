# CI/CD Pipeline - CW_AMD201 

on:

  push:

    branches: [ main ]

  pull_request:

    branches: [ main ]

env:

  DOTNET_VERSION: '8.0.x'

  DOCKER_REPOSITORY: ${{ secrets.DOCKER_USERNAME }}/cw_amd201

jobs:

  # 1. CI PHASE: Build and Test each service

  build-and-test-crud:

    name: Build & Test CRUD Service

    runs-on: ubuntu-latest

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Restore dependencies for the entire solution/project
      - name: Restore Dependencies
        run: dotnet restore CW_AMD201.sln

      - name: Build Solution
        run: dotnet build CW_AMD201.sln --no-restore

      # Run tests for the CRUD service (assuming tests are located in Service_CRUD/Tests)
      - name: Run Unit Tests (CRUD)
        run: dotnet test Test_Crud/Test_Crud.csproj --no-build --verbosity normal

  build-and-test-urlshorten:

    name: Build & Test URL Shorten Service

    runs-on: ubuntu-latest

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore Dependencies
        run: dotnet restore CW_AMD201.sln

      - name: Build Solution
        run: dotnet build CW_AMD201.sln --no-restore

      # Run tests for the URL Shorten service
      - name: Run Unit Tests (URL Shorten)
        run: dotnet test Test_Shorten_Url/Test_Shorten_Url.csproj --no-build --verbosity normal

  build-gateway:

    name: Build API Gateway

    runs-on: ubuntu-latest

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore Dependencies
        run: dotnet restore

      - name: Build Gateway
        run: dotnet build --no-restore Service_API_Gateway # Chỉ build project Gateway

  # 2. CD PHASE: Build and Push Docker Images

  cd-push-docker:

    name: Push Production Images to Docker Hub

    runs-on: ubuntu-latest

    # CD chỉ chạy khi tất cả các Job CI (build và test) đều thành công
    needs: [build-and-test-crud, build-and-test-urlshorten, build-gateway] 

    if: github.ref == 'refs/heads/main' # Chỉ chạy CD khi merge vào nhánh 'main'

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build và Push Image CRUD
      - name: Build and Push CRUD Image
        uses: docker/build-push-action@v5
        with:
          context: ./Service_CRUD
          push: true
          tags: ${{ env.DOCKER_REPOSITORY }}:crud-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build và Push Image URL Shorten
      - name: Build and Push URL Shorten Image
        uses: docker/build-push-action@v5
        with:
          context: ./Service_URL_Shorten
          push: true
          tags: ${{ env.DOCKER_REPOSITORY }}:urlshorten-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build và Push Image API Gateway
      - name: Build and Push API Gateway Image
        uses: docker/build-push-action@v5
        with:
          context: ./Service_API_Gateway
          push: true
          tags: ${{ env.DOCKER_REPOSITORY }}:gateway-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
